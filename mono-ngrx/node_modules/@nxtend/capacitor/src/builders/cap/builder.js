"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.runBuilder = void 0;
const architect_1 = require("@angular-devkit/architect");
const fs = require("fs");
const path_1 = require("path");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const project_root_1 = require("../../utils/project-root");
function runBuilder(options, context) {
    return rxjs_1.from(project_root_1.getProjectRoot(context)).pipe(operators_1.switchMap((projectRoot) => {
        const frontendProjectRoot = path_1.join(context.workspaceRoot, projectRoot);
        let cmd = options.cmd;
        if (cmd[0] === '"' && cmd[cmd.length - 1] === '"') {
            cmd = cmd.substring(1).slice(0, -1);
        }
        const capacitorConfigJson = JSON.parse(fs
            .readFileSync(`${frontendProjectRoot}/capacitor.config.json`)
            .toString());
        let commands = [
            {
                command: `npx cap ${cmd}`,
            },
        ];
        if (options.packageInstall === true ||
            options.packageInstall === undefined) {
            commands = [
                {
                    command: `${capacitorConfigJson.npmClient} install`,
                },
                ...commands,
            ];
        }
        return context.scheduleBuilder('@nrwl/workspace:run-commands', {
            cwd: frontendProjectRoot,
            parallel: false,
            commands,
        });
    }), operators_1.switchMap((run) => run.output));
}
exports.runBuilder = runBuilder;
exports.default = architect_1.createBuilder(runBuilder);
//# sourceMappingURL=builder.js.map